# 上传错误调试指南

## 错误信息
"图片上传到云端失败，请检查网络连接后重试。"

## 问题分析

这个错误出现在以下情况：
1. `roomImage` 存在（不是null）
2. `roomImage` 是blob或data URL格式
3. `convertImageToUrl` 函数返回了 `null`

## 可能的原因

### 1. 网络连接问题
- 本地服务器无法访问云端服务
- 云端服务暂时不可用
- 网络超时

### 2. 图片数据问题
- blob URL已过期
- data URL格式不正确
- 图片数据过大

### 3. 服务器问题
- 上传接口返回错误
- 云端服务返回错误
- 服务器内部错误

## 调试步骤

### 1. 使用调试页面
访问 `/debug-upload` 页面进行详细调试：

1. **选择测试图片**
2. **运行直接上传测试** - 验证基本上传功能
3. **运行convertImageToUrl测试** - 模拟问题场景
4. **查看调试日志** - 分析具体错误

### 2. 检查浏览器控制台
打开浏览器开发者工具，查看控制台日志：

```javascript
// 查找这些日志
[v0] Legacy image format detected, uploading to cloud
[v0] Image data type: blob/data
[v0] Image data length: [数字]
[v0] Starting upload request...
[v0] Upload response status: [状态码]
[v0] Upload response ok: true/false
[v0] Upload response data: [响应数据]
```

### 3. 检查网络请求
在开发者工具的Network标签中：
1. 查找 `/api/upload-image` 请求
2. 检查请求状态码
3. 查看响应内容
4. 检查是否有网络错误

## 常见问题解决

### 问题1: 直接上传成功，但convertImageToUrl失败
**原因**: data URL转换或上传过程中出错
**解决**: 
- 检查data URL格式是否正确
- 检查图片数据大小是否超限
- 查看详细的错误日志

### 问题2: 所有上传都失败
**原因**: 网络连接或服务器问题
**解决**:
- 检查网络连接
- 验证云端服务是否可用
- 检查服务器日志

### 问题3: blob URL过期
**原因**: blob URL有时效性，长时间后可能失效
**解决**:
- 重新上传图片
- 使用新的上传流程（直接上传文件）

## 临时解决方案

### 方案1: 重新上传图片
1. 删除当前图片
2. 重新选择并上传图片
3. 使用新的直接上传流程

### 方案2: 清除缓存
1. 清除浏览器缓存
2. 刷新页面
3. 重新上传图片

### 方案3: 检查网络
1. 确认网络连接正常
2. 尝试访问其他网站
3. 检查防火墙设置

## 预防措施

### 1. 使用新的上传流程
- 用户上传文件时直接上传到云端
- 避免使用blob/data URL
- 减少中间转换步骤

### 2. 增强错误处理
- 提供更详细的错误信息
- 添加重试机制
- 实现降级方案

### 3. 添加监控
- 监控上传成功率
- 记录错误日志
- 设置告警机制

## 调试工具

### 1. 调试页面
- 路径: `/debug-upload`
- 功能: 详细的上传测试和日志
- 用途: 定位具体问题

### 2. 浏览器控制台
- 查看详细日志
- 检查网络请求
- 分析错误堆栈

### 3. 服务器日志
- 检查API响应
- 查看错误详情
- 监控性能指标

## 联系支持

如果问题持续存在，请提供：
1. 浏览器控制台的完整日志
2. 网络请求的详细信息
3. 重现问题的具体步骤
4. 使用的浏览器和操作系统信息

这样可以帮助快速定位和解决问题。
